<div class="page-wrapper">
  <app-page-header title="Digital Services"></app-page-header>

  <!-- Tabs -->
  <div class="tabs-container mb-6">
    <button
      type="button"
      (click)="setActiveTab('Connect')"
      [class]="
        activeTab() === 'Connect'
          ? 'tab-button active'
          : 'tab-button'
      "
    >
      Connect
    </button>
    <button
      type="button"
      (click)="setActiveTab('Utilities')"
      [class]="
        activeTab() === 'Utilities'
          ? 'tab-button active'
          : 'tab-button'
      "
    >
      Utilities
    </button>
    <button
      type="button"
      (click)="setActiveTab('Security')"
      [class]="
        activeTab() === 'Security'
          ? 'tab-button active'
          : 'tab-button'
      "
    >
      Security
    </button>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="flex justify-center items-center py-12">
      <div class="text-gray-500">Loading services...</div>
    </div>
  }

  <!-- Products Grid -->
  @if (!loading()) {
    <div class="products-grid">
      @for (product of filteredProducts(); track product.id) {
        <div class="card-theme rounded-card shadow-sm p-4" [class]="getProviderColor(product.provider)">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-3">
              <div class="icon-wrapper">
                @switch (product.icon) {
                  @case ('wifi') {
                    <lucide-angular [img]="Wifi" class="w-6 h-6"></lucide-angular>
                  }
                  @case ('zap') {
                    <lucide-angular [img]="Zap" class="w-6 h-6"></lucide-angular>
                  }
                  @case ('phone') {
                    <lucide-angular [img]="Phone" class="w-6 h-6"></lucide-angular>
                  }
                  @case ('bolt') {
                    <lucide-angular [img]="Bolt" class="w-6 h-6"></lucide-angular>
                  }
                  @case ('shield') {
                    <lucide-angular [img]="Shield" class="w-6 h-6"></lucide-angular>
                  }
                  @case ('heart') {
                    <lucide-angular [img]="Heart" class="w-6 h-6"></lucide-angular>
                  }
                  @case ('piggy-bank') {
                    <lucide-angular [img]="PiggyBank" class="w-6 h-6"></lucide-angular>
                  }
                  @default {
                    <lucide-angular [img]="Wifi" class="w-6 h-6"></lucide-angular>
                  }
                }
              </div>
              <div>
                <h3 class="font-semibold text-hive-900">{{ product.name }}</h3>
                <p class="text-sm text-gray-500">{{ product.provider }}</p>
              </div>
            </div>
          </div>

          <p class="text-sm text-gray-600 mb-4">{{ product.description }}</p>

          <div class="flex items-center justify-between">
            <div class="price">
              @if (product.price === 'Variable') {
                <span class="text-lg font-semibold text-hive-900">Variable</span>
              } @else {
                <span class="text-lg font-semibold text-hive-900">${{ product.price }}</span>
              }
            </div>
            <button
              type="button"
              class="btn-primary"
              (click)="openModal(product)"
            >
              {{ getActionLabel(product) }}
            </button>
          </div>
        </div>
      }
    </div>
  }

  <!-- Smart Pay Modal -->
  @if (showModal() && selectedProduct()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="text-xl font-bold text-hive-900">Smart Pay</h2>
          <button type="button" class="close-button" (click)="closeModal()">
            <lucide-angular [img]="X" class="w-6 h-6"></lucide-angular>
          </button>
        </div>

        <div class="modal-body">
          <!-- Product Info -->
          <div class="product-summary mb-6">
            <h3 class="font-semibold text-hive-900 mb-1">{{ selectedProduct()?.name }}</h3>
            <p class="text-sm text-gray-600">{{ selectedProduct()?.description }}</p>
            <div class="mt-2">
              @if (selectedProduct()?.price === 'Variable') {
                <span class="text-lg font-semibold text-hive-900">Variable Amount</span>
              } @else {
                <span class="text-lg font-semibold text-hive-900">${{ selectedProduct()?.price }}</span>
              }
            </div>
          </div>

          <!-- Variable Amount Input -->
          @if (selectedProduct()?.price === 'Variable') {
            <div class="form-group mb-6">
              <label class="form-label">Amount</label>
              <input
                type="number"
                class="input-field"
                [min]="selectedProduct()?.provider === 'ZESA' ? 5 : 1"
                [step]="0.01"
                [ngModel]="variableAmountInput()"
                (ngModelChange)="updateVariableAmount($event)"
                placeholder="Enter amount"
              />
              @if (selectedProduct()?.provider === 'ZESA') {
                <p class="text-xs text-gray-500 mt-1">Minimum: $5.00</p>
              }
            </div>
          }

          <!-- Payment Source Dropdown -->
          <div class="form-group mb-6">
            <label class="form-label">Payment Source</label>
            <select 
              class="input-field" 
              [ngModel]="paymentSourceInput()"
              (ngModelChange)="updatePaymentSource($event)"
            >
              <option value="wallet">Wallet Balance (${{ walletBalance().toFixed(2) }})</option>
              <option value="circle">Savings Circle Payout</option>
            </select>
          </div>

          <!-- Total Amount -->
          <div class="total-section">
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Total Amount:</span>
              <span class="text-2xl font-bold text-hive-900">${{ getTotalAmount().toFixed(2) }}</span>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-outline" (click)="closeModal()">
            Cancel
          </button>
          <button
            type="button"
            class="btn-primary"
            [disabled]="!canProceed()"
            (click)="processPayment()"
          >
            Confirm Payment
          </button>
        </div>
      </div>
    </div>
  }
</div>
