<div class="page-wrapper">
  @if (loading()) {
    <div class="flex items-center justify-center min-h-[60vh]">
      <div class="text-center">
        <div class="spinner w-12 h-12 mx-auto mb-4"></div>
        <p class="text-text-secondary">Loading storefront data...</p>
      </div>
    </div>
  } @else if (storefront(); as store) {
    <!-- Header -->
    <div class="mb-6 flex items-start justify-between">
      <div>
        <h1 class="text-3xl font-display font-bold text-text-primary mb-2">
          {{ store.name }}
        </h1>
        <a
          [href]="'https://hivefund.zw/store/' + store.slug"
          target="_blank"
          class="text-xs text-hive-500 hover:text-hive-600 hover:underline"
          rel="noopener noreferrer"
        >
          hivefund.zw/store/{{ store.slug }}
        </a>
      </div>
      <div class="flex items-center gap-3">
        <button
          class="btn-outline flex items-center gap-2 py-2 px-4 text-sm"
          (click)="viewLiveStore()"
        >
          <lucide-icon [name]="ExternalLink" class="w-4 h-4"></lucide-icon>
          Preview Store
        </button>
        <button
          class="p-2 text-text-secondary hover:text-hive-500 transition-colors"
          title="Settings"
        >
          <lucide-icon [name]="Settings" class="w-5 h-5"></lucide-icon>
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="border-b border-cream-300 mb-6">
      <div class="flex gap-8">
        <button
          class="pb-3 px-1 font-medium transition-colors relative"
          [ngClass]="{
            'text-hive-600 border-b-2 border-honey-600': activeTab() === 'products',
            'text-text-secondary hover:text-text-primary': activeTab() !== 'products'
          }"
          (click)="setActiveTab('products')"
        >
          Products
        </button>
        <button
          class="pb-3 px-1 font-medium transition-colors relative"
          [ngClass]="{
            'text-hive-600 border-b-2 border-honey-600': activeTab() === 'orders',
            'text-text-secondary hover:text-text-primary': activeTab() !== 'orders'
          }"
          (click)="setActiveTab('orders')"
        >
          Orders
        </button>
        <button
          class="pb-3 px-1 font-medium transition-colors relative"
          [ngClass]="{
            'text-hive-600 border-b-2 border-honey-600': activeTab() === 'analytics',
            'text-text-secondary hover:text-text-primary': activeTab() !== 'analytics'
          }"
          (click)="setActiveTab('analytics')"
        >
          Analytics
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Products Tab -->
      @if (activeTab() === 'products') {
        <div>
          <!-- Header -->
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-display font-semibold text-text-primary">
              Your Products ({{ store.products.length }})
            </h2>
            <button class="btn-primary flex items-center gap-2">
              <lucide-icon [name]="Tag" class="w-4 h-4"></lucide-icon>
              Add Product
            </button>
          </div>

          <!-- Products List -->
          <div class="space-y-4">
            @for (product of store.products; track product.id) {
              <div class="dashboard-card flex items-center gap-4">
                <!-- Thumbnail -->
                <div class="w-20 h-20 bg-cream-100 rounded-lg flex items-center justify-center shrink-0">
                  <lucide-icon [name]="Image" class="w-8 h-8 text-text-tertiary"></lucide-icon>
                </div>

                <!-- Product Info -->
                <div class="flex-1 min-w-0">
                  <h3 class="font-display font-semibold text-text-primary truncate">
                    {{ product.name }}
                  </h3>
                  <p class="text-lg font-bold text-honey-600">
                    ${{ product.price | number: '1.2-2' }}
                  </p>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-4">
                  <!-- Toggle Switch -->
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      [checked]="product.isAvailable"
                      (change)="toggleProductAvailability(product.id)"
                      class="sr-only peer"
                    />
                    <div class="relative w-11 h-6 bg-cream-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-hive-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-cream-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-hive-500"></div>
                    <span class="text-sm text-text-secondary">
                      {{ product.isAvailable ? 'Available' : 'Unavailable' }}
                    </span>
                  </label>

                  <!-- Icon Buttons -->
                  <button
                    class="p-2 text-text-secondary hover:text-hive-500 transition-colors"
                    title="Edit"
                  >
                    <lucide-icon [name]="Edit" class="w-5 h-5"></lucide-icon>
                  </button>
                  <button
                    class="p-2 text-text-secondary hover:text-danger transition-colors"
                    (click)="deleteProduct(product.id)"
                    title="Delete"
                  >
                    <lucide-icon [name]="Trash2" class="w-5 h-5"></lucide-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Orders Tab -->
      @if (activeTab() === 'orders') {
        <div>
          <!-- Filter -->
          <div class="mb-6 flex gap-3">
            <button
              class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              [ngClass]="{
                'bg-hive-50 text-hive-700': orderFilter() === 'all',
                'text-text-secondary hover:text-text-primary': orderFilter() !== 'all'
              }"
              (click)="orderFilter.set('all')"
            >
              All Orders
            </button>
            <button
              class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              [ngClass]="{
                'bg-hive-50 text-hive-700': orderFilter() === 'pending',
                'text-text-secondary hover:text-text-primary': orderFilter() !== 'pending'
              }"
              (click)="orderFilter.set('pending')"
            >
              Pending
            </button>
            <button
              class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              [ngClass]="{
                'bg-hive-50 text-hive-700': orderFilter() === 'completed',
                'text-text-secondary hover:text-text-primary': orderFilter() !== 'completed'
              }"
              (click)="orderFilter.set('completed')"
            >
              Completed
            </button>
          </div>

          <!-- Orders List -->
          <div class="space-y-4">
            @for (order of getFilteredOrders(); track order.id) {
              <div class="dashboard-card">
                <!-- Header -->
                <div class="flex items-start justify-between mb-3">
                  <div>
                    <h3 class="font-display font-semibold text-text-primary">
                      Order #{{ order.id }}
                    </h3>
                    <p class="text-sm text-text-secondary">
                      {{ formatDate(order.date) }}
                    </p>
                  </div>
                  <span
                    class="px-3 py-1 rounded-full text-sm font-medium"
                    [ngClass]="{
                      'bg-warning-light text-warning-dark': order.status === 'pending',
                      'bg-hive-50 text-hive-700': order.status === 'completed'
                    }"
                  >
                    {{ order.status === 'pending' ? 'Pending' : 'Completed' }}
                  </span>
                </div>

                <!-- Body -->
                <div class="mb-3">
                  <p class="text-text-primary">{{ getOrderItemsSummary(order) }}</p>
                  <p class="text-lg font-bold text-honey-600 mt-1">
                    Total: ${{ order.total | number: '1.2-2' }}
                  </p>
                </div>

                <!-- Footer -->
                <div class="flex items-center justify-between pt-3 border-t border-cream-200">
                  <p class="text-sm text-text-secondary">
                    Customer: {{ order.customerPhone }}
                  </p>
                  @if (order.status === 'pending') {
                    <button
                      class="btn-outline py-2 px-4 text-sm"
                      (click)="markOrderComplete(order.id)"
                    >
                      Mark Complete
                    </button>
                  }
                </div>
              </div>
            }

            @if (getFilteredOrders().length === 0) {
              <div class="text-center py-12">
                <lucide-icon [name]="Package" class="w-12 h-12 text-text-tertiary mx-auto mb-3"></lucide-icon>
                <p class="text-text-secondary">No orders found</p>
              </div>
            }
          </div>
        </div>
      }

      <!-- Analytics Tab -->
      @if (activeTab() === 'analytics' && analytics(); as analyticsData) {
        <div class="space-y-6">
          <!-- Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Revenue Card -->
            <div class="dashboard-card">
              <div class="flex items-center gap-2 mb-2">
                <lucide-icon [name]="BarChart2" class="w-5 h-5 text-honey-600"></lucide-icon>
                <p class="text-sm text-text-secondary">Total Revenue</p>
              </div>
              <p class="text-3xl font-display font-bold text-honey-600">
                ${{ analyticsData.revenue | number: '1.2-2' }}
              </p>
            </div>

            <!-- Orders Card -->
            <div class="dashboard-card">
              <div class="flex items-center gap-2 mb-2">
                <lucide-icon [name]="ShoppingBag" class="w-5 h-5 text-hive-500"></lucide-icon>
                <p class="text-sm text-text-secondary">Total Orders</p>
              </div>
              <p class="text-3xl font-display font-bold text-text-primary">
                {{ analyticsData.totalOrders }}
              </p>
            </div>

            <!-- Avg Sale Card -->
            <div class="dashboard-card">
              <div class="flex items-center gap-2 mb-2">
                <lucide-icon [name]="Tag" class="w-5 h-5 text-hive-500"></lucide-icon>
                <p class="text-sm text-text-secondary">Average Sale</p>
              </div>
              <p class="text-3xl font-display font-bold text-text-primary">
                ${{ analyticsData.avgSale | number: '1.2-2' }}
              </p>
            </div>
          </div>

          <!-- Mukando Tracker Widget -->
          @if (analyticsData.mukandoContributionDue) {
            <div class="dashboard-card bg-linear-to-br from-hive-50 to-white border-2 border-hive-100">
              <h3 class="text-xl font-display font-bold text-text-primary mb-4">
                Mukando Tracker
              </h3>

              <div class="space-y-3 mb-4">
                <div class="flex justify-between items-center">
                  <span class="text-text-secondary">{{ getCurrentMonth() }} Earnings:</span>
                  <span class="text-2xl font-display font-bold text-honey-600">
                    ${{ analyticsData.revenue | number: '1.2-2' }}
                  </span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-text-secondary">Mukando Due:</span>
                  <span class="text-lg font-display font-semibold text-text-primary">
                    ${{ analyticsData.mukandoContributionDue | number: '1.2-2' }}
                  </span>
                </div>
              </div>

              <!-- Progress Bar -->
              <div class="mb-4">
                <div class="w-full bg-cream-200 rounded-full h-3 overflow-hidden">
                  <div
                    class="h-full rounded-full transition-all duration-500"
                    [ngClass]="{
                      'bg-success': getMukandoProgress() >= 100,
                      'bg-honey-500': getMukandoProgress() < 100
                    }"
                    [style.width.%]="getMukandoProgress()"
                  ></div>
                </div>
                <p class="text-sm text-text-secondary mt-2 text-center">
                  @if (canContributeToMukando()) {
                    <span class="text-success font-semibold">You have surplus funds! ðŸŽ‰</span>
                  } @else {
                    <span>{{ getMukandoProgress() | number: '1.0-0' }}% of monthly goal</span>
                  }
                </p>
              </div>

              <!-- Action Button -->
              @if (canContributeToMukando()) {
                <button class="btn-primary w-full">
                  Add to Mukando
                </button>
              }
            </div>
          }

          <!-- Top Products -->
          @if (analyticsData.topProducts.length > 0) {
            <div class="dashboard-card">
              <h3 class="text-xl font-display font-bold text-text-primary mb-4">
                Top Products
              </h3>
              <div class="space-y-3">
                @for (product of analyticsData.topProducts; track product.name; let i = $index) {
                  <div class="flex items-center justify-between p-3 bg-cream-50 rounded-lg">
                    <div class="flex items-center gap-3">
                      <span class="text-lg font-display font-bold text-text-tertiary">
                        {{ i + 1 }}.
                      </span>
                      <span class="font-medium text-text-primary">
                        {{ product.name }}
                      </span>
                    </div>
                    <span class="font-display font-bold text-honey-600">
                      ${{ product.revenue | number: '1.2-2' }}
                    </span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
